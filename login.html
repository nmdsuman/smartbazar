<!doctype html>
<html lang="bn">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Locker Bazar - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>html,body{font-family:Inter,ui-sans-serif,system-ui}</style>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="configAlert" class="hidden m-3 rounded-lg border border-amber-300 bg-amber-50 text-amber-900 p-3 text-sm">Firebase কনফিগার অনুপস্থিত। <code>__firebase_config</code> এবং <code>__app_id</code> দিন।</div>

    <div class="min-h-screen flex items-center justify-center p-4">
      <div class="w-full max-w-sm bg-white border border-gray-200 rounded-2xl p-6 space-y-4">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-green-600 text-white font-bold">LB</span>
          <div>
            <h1 class="text-lg font-semibold">Locker Bazar Admin</h1>
            <p class="text-xs text-gray-500">লগইন করুন</p>
          </div>
        </div>
        <form id="loginForm" class="space-y-3">
          <div>
            <label class="block text-sm mb-1">ইমেইল</label>
            <input id="email" type="email" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600" required />
          </div>
          <div>
            <label class="block text-sm mb-1">পাসওয়ার্ড</label>
            <input id="password" type="password" class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600" required />
          </div>
          <button class="w-full rounded-lg bg-green-600 text-white px-4 py-2 font-medium hover:bg-green-700 transition transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-offset-2">লগইন</button>
          <p class="text-xs text-gray-600">একাউন্ট নেই? <a href="signup.html" class="text-green-700 hover:underline transition transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-offset-2 inline-flex">সাইন আপ করুন</a></p>
          <p id="authError" class="hidden text-sm text-red-600"></p>
        </form>
      </div>
    </div>

    <!-- Firebase Config (Provided) -->
    <script>
      window.__firebase_config = {
        apiKey: "AIzaSyAcj9y2jgxqatG3_IXkBjMT0yvBoardpJw",
        authDomain: "bazar-201e6.firebaseapp.com",
        projectId: "bazar-201e6",
        storageBucket: "bazar-201e6.firebasestorage.app",
        messagingSenderId: "465394666878",
        appId: "1:465394666878:web:7f4ecb390746a57baef72f",
        measurementId: "G-3WJ6CCGSYS"
      };
      window.__app_id = "bazar-201e6";
    </script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
      const qs = (s, r=document) => r.querySelector(s);
      let app=null, auth=null, db=null, basePath=null;

      async function initFirebase(){
        const missing = !(window.__firebase_config && window.__app_id);
        if (missing) { qs('#configAlert').classList.remove('hidden'); return; }
        try{
          app = firebase.initializeApp(window.__firebase_config);
          auth = firebase.auth();
          db = firebase.firestore();
          basePath = `artifacts/${window.__app_id}/public/data`;
          qs('#configAlert').classList.add('hidden');
        }catch(e){ console.error(e); qs('#configAlert').classList.remove('hidden'); }
      }

      async function isAdmin(uid){
        const snap = await db.collection(`${basePath}/admins`).doc(uid).get();
        return snap.exists;
      }

      window.addEventListener('DOMContentLoaded', async ()=>{
        await initFirebase();
        if (!auth) return;

        qs('#loginForm').addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = qs('#email').value.trim();
          const password = qs('#password').value;
          const err = qs('#authError');
          err.classList.add('hidden'); err.textContent='';
          try{
            const { user } = await auth.signInWithEmailAndPassword(email, password);
            const admin = await isAdmin(user.uid);
            // Upsert user profile with role
            try{
              await db.collection(`${basePath}/users`).doc(user.uid).set({
                email: user.email || email,
                role: admin ? 'admin' : 'user',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              }, { merge: true });
            }catch{}
            try{ localStorage.setItem('lb_last_login', '1'); }catch{}
            await new Promise(r=>setTimeout(r, 400));
            window.location.href = admin ? 'admin.html' : 'index.html';
          }catch(e){
            err.classList.remove('hidden'); err.textContent='লগইন ব্যর্থ';
          }
        });
      });
    </script>
  </body>
</html>
